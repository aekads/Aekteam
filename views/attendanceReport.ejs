<!DOCTYPE html>
<html lang="en">
<head>
  <title>Attendance Report</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f0f2f5;
      font-family: 'Poppins', sans-serif;
    }
    .modal {
      display: none;
    }
    .modal.active {
      display: flex;
    }
  </style>
</head>
<body>
  <%- include('./partials/hrsidebar') %>

  <div class="main p-6 ml-80">
    <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Attendance Report</h2>

    <!-- Tabs -->
    <div class="flex justify-center mb-4 space-x-4">
      <a href="?tab=particular" class="px-5 py-2 rounded-md text-white font-medium <%= filters.emp_id !== 'all' ? 'bg-blue-600' : 'bg-gray-400' %>">Particular Employee</a>
      <a href="?emp_id=all&start_date=<%= filters.start_date || '' %>&end_date=<%= filters.end_date || '' %>" class="px-5 py-2 rounded-md text-white font-medium <%= filters.emp_id === 'all' ? 'bg-blue-600' : 'bg-gray-400' %>">All Employees</a>
    </div>

    <!-- Filter Form -->
    <form method="GET" action="/dashboard/hr/attendanceReport" class="flex flex-wrap justify-center gap-4 bg-white p-4 rounded-lg shadow-md mb-6">
      <div>
        <select name="emp_id" id="emp_id" class="border border-gray-300 rounded-md p-2">
          <option value="" disabled selected>Select Employee</option>
          <option value="all" <%= filters.emp_id === 'all' ? 'selected' : '' %>>All Employees</option>
          <% employees.forEach(emp => { %>
            <option value="<%= emp.emp_id %>" <%= filters.emp_id == emp.emp_id ? 'selected' : '' %>><%= emp.name %></option>
          <% }); %>
        </select>
      </div>
      <div>
        <input type="date" name="start_date" value="<%= filters.start_date || '' %>" class="border border-gray-300 rounded-md p-2">
      </div>
      <div>
        <input type="date" name="end_date" value="<%= filters.end_date || '' %>" class="border border-gray-300 rounded-md p-2">
      </div>
      <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700">Show Report</button>
      <button type="button" id="exportExcel" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700">Export Excel</button>
    </form>

    <% if (!isAllEmployees && summary) { %>
      <!-- Particular Employee Summary -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-green-100 text-green-700 p-4 rounded-lg shadow text-center">
          <p>Total Days</p>
          <h2 class="text-2xl font-bold"><%= summary.totalDays %></h2>
        </div>
        <div class="bg-blue-100 text-blue-700 p-4 rounded-lg shadow text-center">
          <p>Present</p>
          <h2 class="text-2xl font-bold"><%= summary.totalPresent %></h2>
        </div>
        <div class="bg-red-100 text-red-700 p-4 rounded-lg shadow text-center">
          <p>Absent</p>
          <h2 class="text-2xl font-bold"><%= summary.totalAbsent %></h2>
        </div>
        <div class="bg-yellow-100 text-yellow-700 p-4 rounded-lg shadow text-center">
          <p>Official/Festival/Half Leave</p>
          <h2 class="text-2xl font-bold"><%= summary.totalLeaves %></h2>
        </div>
      </div>
    <% } %>

    <% if (!isAllEmployees && attendanceData.length > 0) { %>
      <!-- Table: Particular Employee -->
      <div class="overflow-x-auto bg-white rounded-lg shadow-md">
        <table class="w-full border border-gray-200">
          <thead class="bg-blue-600 text-white">
            <tr>
              <th class="py-3 px-4">Date</th>
              <th class="py-3 px-4">Day</th>
              <th class="py-3 px-4">Punch In</th>
              <th class="py-3 px-4">Punch Out</th>
              <th class="py-3 px-4">Status</th>
            </tr>
          </thead>
          <tbody>
            <% attendanceData.forEach(rec => { %>
              <tr class="text-center hover:bg-gray-100">
                <td class="py-2 px-3"><%= new Date(rec.date).toLocaleDateString('en-IN') %></td>
                <td class="py-2 px-3"><%= rec.day %></td>
                <td class="py-2 px-3"><%= rec.punch_in_time ? new Date(rec.punch_in_time).toLocaleTimeString('en-IN') : '-' %></td>
                <td class="py-2 px-3"><%= rec.punch_out_time ? new Date(rec.punch_out_time).toLocaleTimeString('en-IN') : '-' %></td>
                <td class="py-2 px-3 font-semibold 
                    <%= rec.status.includes('Half Day') ? 'text-orange-500' :
                        rec.status === 'Present' ? 'text-green-600' :
                        rec.status === 'Official Leave' ? 'text-yellow-600' :
                        rec.status === 'Festival Leave' ? 'text-purple-600' :
                        'text-red-600' %>">
                  <%= rec.status %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>

    <% if (isAllEmployees && summary && summary.length > 0) { %>
      <!-- Table: All Employees Summary -->
      <div class="overflow-x-auto bg-white rounded-lg shadow-md">
        <table class="w-full border border-gray-200">
        <thead class="bg-indigo-700 text-white">
  <tr>
    <th class="py-3 px-4">Employee Name</th>
    <th class="py-3 px-4">Present</th>
    <th class="py-3 px-4">Absent</th>
    <th class="py-3 px-4">Official Leave</th>
    <th class="py-3 px-4">Festival Leave</th>
   
  </tr>
</thead>
<tbody>
  <% summary.forEach(s => { %>
    <tr class="text-center hover:bg-gray-100">
      <td class="py-2 px-3 font-medium text-blue-600 cursor-pointer emp-name" data-empid="<%= s.emp_id %>">
        <%= s.name %>
      </td>
      <td class="py-2 px-3 text-green-600 font-semibold"><%= s.totalPresent || 0 %></td>
      <td class="py-2 px-3 text-red-600 font-semibold"><%= s.totalAbsent || 0 %></td>
      <td class="py-2 px-3 text-yellow-600 font-semibold"><%= s.totalLeaves || 0 %></td>
      <td class="py-2 px-3 text-purple-600 font-semibold"><%= s.totalFestival || 0 %></td>
   
    </tr>
  <% }) %>
</tbody>
        </table>
      </div>
    <% } %>
  </div>

  <!-- Modal -->
  <div id="leaveModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 justify-center items-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
      <h3 class="text-xl font-semibold mb-3 text-center text-blue-700">Employee Leave Details</h3>
      <table class="w-full border border-gray-300 rounded-md mb-4">
        <thead class="bg-gray-100">
          <tr>
            <th class="py-2 px-3 border">Date</th>
            <th class="py-2 px-3 border">Type</th>
          </tr>
        </thead>
        <tbody id="leaveTableBody"></tbody>
      </table>
      <button id="closeModal" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 w-full">Close</button>
    </div>
  </div>

  <script>
    // ✅ Export Excel
    document.getElementById("exportExcel")?.addEventListener("click", function () {
      const empId = document.getElementById("emp_id").value;
      const start = document.querySelector("[name='start_date']").value;
      const end = document.querySelector("[name='end_date']").value;
      if (!empId || !start || !end) {
        alert("Please select employee and date range!");
        return;
      }
      window.location.href = `/dashboard/hr/exportAttendance?emp_id=${empId}&start_date=${start}&end_date=${end}`;
    });

    // ✅ Modal for leave details
    const modal = document.getElementById("leaveModal");
    const modalBody = document.getElementById("leaveTableBody");
    const closeModal = document.getElementById("closeModal");

    document.querySelectorAll(".emp-name").forEach(el => {
      el.addEventListener("click", async () => {
        const empId = el.getAttribute("data-empid");
        const res = await fetch(`/dashboard/hr/employeeLeaves?emp_id=${empId}`);
        const data = await res.json();
        modalBody.innerHTML = "";
        if (data.length === 0) {
          modalBody.innerHTML = "<tr><td colspan='2' class='text-center py-2'>No Leave Records</td></tr>";
        } else {
          data.forEach(lv => {
            const type = lv.half_day ? `Half Day (${lv.half_day})` : "Full Day";
            modalBody.innerHTML += `<tr><td class='border py-2 px-3 text-center'>${new Date(lv.date).toLocaleDateString('en-IN')}</td><td class='border py-2 px-3 text-center'>${type}</td></tr>`;
          });
        }
        modal.classList.add("active");
      });
    });

    closeModal.addEventListener("click", () => modal.classList.remove("active"));
  </script>
</body>
</html>
